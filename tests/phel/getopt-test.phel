(ns tests\smeghead\getopt\getopt-test
  (:require smeghead\getopt\getopt)
  (:require phel\test :refer [deftest is]))

(deftest run-no-argv
  (let [options []
        result (getopt/getopt [] options)]
    (is (= (result :args) []))
    (is (= (result :options) {}))))

(deftest run-2-arguments
  (let [options []
        result (getopt/getopt ["one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {}))))

(deftest option-short-options
  (let [options ["-a"]
        result (getopt/getopt ["-a" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:a true}))))

(deftest option-short-options-require-value
  (let [options ["-a:"]
        result (getopt/getopt ["-a" "param" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:a "param"}))))

(deftest option-short-options-require-value-combined
  (let [options ["-a:"]
        result (getopt/getopt ["-aparam" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:a "param"}))))

(deftest option-short-options-require-value-missing
  (let [options ["-a:" "-b"]
        result (getopt/getopt ["-a" "-b" "one" "two"] options)]
    (is (= (result :errors) ["Missing value option: \"-a\""]))
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:b true}))))

(deftest option-short-options-require-value-missing-last-position
  (let [options ["-a:"]
        result (getopt/getopt ["one" "two" "-a"] options)]
    (is (= (result :errors) ["Missing value option: \"-a\""]))
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {}))))

(deftest option-long-options
  (let [options ["--amazing"]
        result (getopt/getopt ["--amazing" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:amazing true}))))

(deftest option-long-options-includes--
  (let [options ["--amazing-thing"]
        result (getopt/getopt ["--amazing-thing" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:amazing-thing true}))))

(deftest option-long-options-require-value-combined
  (let [options ["--amazing:"]
        result (getopt/getopt ["--amazing=man" "one" "two"] options)]
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {:amazing "man"}))))

(deftest option-unknown-options
  (let [options ["-a"]
        result (getopt/getopt ["--unknown" "one" "two"] options)]
    (is (= (result :errors) ["Unknown option: \"--unknown\""]))
    (is (= (result :args) ["one" "two"]))
    (is (= (result :options) {}))))

(deftest option-give-up-parse-after---
  (let [options ["-a"]
        result (getopt/getopt ["--" "-a" "one" "two"] options)]
    (is (= (result :args) ["-a" "one" "two"]))
    (is (= (result :options) {}))))
